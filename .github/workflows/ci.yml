name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────
  # Go Services — lint, fmt, vet, build
  # ──────────────────────────────────────────────
  go-ci:
    name: Go CI
    runs-on: ubuntu-latest

    strategy:
      matrix:
        module:
          - api-gateway
          - payment-service
          - account-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: "${{ matrix.module }}/go.sum"

      # ── gofmt ──
      - name: Check gofmt
        working-directory: ${{ matrix.module }}
        run: |
          UNFORMATTED=$(gofmt -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files are not formatted:"
            echo "$UNFORMATTED"
            exit 1
          fi
          echo "All files are formatted."

      # ── go vet ──
      - name: Run go vet
        working-directory: ${{ matrix.module }}
        run: go vet ./...

      # ── staticcheck ──
      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        working-directory: ${{ matrix.module }}
        run: staticcheck ./...

      # ── golangci-lint ──
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ${{ matrix.module }}
          args: --timeout=5m

      # ── build ──
      - name: Build
        working-directory: ${{ matrix.module }}
        run: go build -v ./...

  # ──────────────────────────────────────────────
  # Proto — validate generated code compiles
  # ──────────────────────────────────────────────
  proto-ci:
    name: Proto CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: "proto/go.sum"

      - name: Build proto module
        working-directory: proto
        run: go build ./...

  # ──────────────────────────────────────────────
  # Notification Service (Java) — compile
  # ──────────────────────────────────────────────
  java-ci:
    name: Java CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build with Maven
        working-directory: notification-service
        run: mvn -B compile --no-transfer-progress
